---
title: "Prior elicitation"
output: html_notebook
---

```{r}
library(tidyverse)
library(tidyboot)
library(ggpirate)
library(knitr)
library(viridis)
library(tidytext)
readData = function(proj){
  read_csv(
    paste("../../data/prior/",proj,"/",
          proj,"-trials.csv", sep = "")
    )
}

readCatchInfo = function(proj){
  read_csv(
    paste("../../data/prior/",proj,"/",
          proj,"-catch_trials.csv", sep = "")
    )
}

readSubjInfo = function(proj){
  read_csv(
    paste("../../data/prior/",proj,"/",
          proj,"-subject_information.csv", sep = "")
    )
}
```

# Prior 2

## Subject information

```{r}
df.prior.2 <- readData("prior-2")
 
df.prior.2.subj <- readSubjInfo("prior-2")
df.prior.2.subj %>%
  select(problems, comments) %>%
  kable()
```

## Catch trials

```{r}
df.prior.2.catch <- readCatchInfo("prior-2")

df.prior.2.catch.summary <- df.prior.2.catch %>%
  group_by(workerid, tested_on) %>%
  summarize(totalCorrect = sum(correct)) %>%
  ungroup() %>%
  spread(tested_on, totalCorrect) %>%
  rename(correct_rejection = `0`, 
         hit = `1`) %>%
  mutate(pass = ifelse(hit >= 4 & correct_rejection >= 4, 1, 0),
         totalCorrect = correct_rejection + hit)

df.prior.2.catch.summary %>%
  select(pass) %>%
  table()
```

remove catch trial failures

```{r}
df.prior.2 <- left_join(df.prior.2, df.prior.2.catch.summary %>%
                         select(workerid, totalCorrect, pass))

df.prior.2.filtered <- df.prior.2 %>% filter(pass == 1)

```



## What categories do people produce?

```{r}
df.prior.categories.2 <- df.prior.2.filtered %>%
  filter(trial_type == "category_elicitation") %>%
  mutate(response = gsub("&quotechar", "", response)) %>%
  unnest_tokens(word, response) %>%
  anti_join(stop_words)

df.prior.categories.2 %>%
  group_by(word) %>%
  count() %>%
  kable()

d.tidy.wordCounts <- df.prior.categories.2 %>%
  count(animal_class,word)

d.tidy.wordCounts[with(d.tidy.wordCounts, order(animal_class, -n)),] %>%
  kable()
```


## Prevalence priors

```{r}
df.prior.prevalence.2 <- df.prior.2.filtered %>%
  filter(trial_type == "prevalence_elicitation", !(is.na(response))) %>%
  mutate(response = as.numeric(response))
```


Histogram of number of responses per item

```{r}
df.prior.prevalence.2 %>%
  group_by(property) %>%
  count() %>%
  ggplot(., aes(x = n / 5))+
  geom_bar()+
  ylab("number of items")+
  xlab("number of participants rated item")
```

Distribution of all responses (collapse item)

```{r}
df.prior.prevalence.2 %>%
  ggplot(., aes( x = response ))+
  geom_histogram()
```

Item distributions (prevalence priors)

```{r fig.width = 18, fig.height = 8}
df.prior.prevalence.2 %>%
  ggplot(., aes( x = response ))+
  geom_histogram( bins = 20,aes(y=(..count..)/tapply(..count..,..PANEL..,sum)[..PANEL..]
    ))+
  facet_wrap(~property, scales = 'free') +
  scale_x_continuous(limits = c(-0.1, 1.1), breaks = c(0, 0.5, 1))

ggsave("figs/prior-2-prevpriors-n144.pdf", width = 20, height = 14)
```

Item distributions conditional on > 0

```{r fig.width = 18, fig.height = 8}
df.prior.prevalence.2 %>%
  filter(response > 0) %>%
  ggplot(., aes( x = response ))+
  geom_histogram( bins = 20,aes(y=(..count..)/tapply(..count..,..PANEL..,sum)[..PANEL..]
    ))+
  facet_wrap(~property, scales = 'free') +
  scale_x_continuous(limits = c(-0.1, 1.1), breaks = c(0, 0.5, 1))

ggsave("figs/prior-2-prevpriorsNonZero-n144.pdf", width = 20, height = 14)
```

Distribution of expected values

```{r}
df.prior.2.ev <- df.prior.prevalence.2 %>%
  group_by(property) %>%
  tidyboot_mean(column = response)

ggplot(df.prior.2.ev, aes ( x = mean ))+
  geom_histogram(bins = 20)

ggsave("figs/prior-2-expvals-n144.pdf", width = 4, height = 4)

```


Distribution of expected values conditional on non-zero prevalence

```{r}
df.prior.2.conditional.ev <- df.prior.prevalence.2 %>%
  filter(response > 0) %>%
  group_by(property) %>%
  tidyboot_mean(column = response)

ggplot(df.prior.2.conditional.ev, aes ( x = mean ))+
  geom_histogram(bins = 20)

ggsave("figs/prior-2-nonZeroExpvals-n144.pdf", width = 4, height = 4)

```

```{r}
df.prior.prevalence.2.isZero <- df.prior.prevalence.2 %>%
  mutate(isZero = ifelse(response == 0, 1, 0)) %>%
  group_by(property) %>%
  tidyboot_mean(column = isZero)


ggplot(df.prior.prevalence.2.isZero, aes ( x = mean ))+
  geom_histogram(bins = 20)

ggsave("figs/prior-2-isZero-n144.pdf", width = 4, height = 4)
```

```{r}

df.prior.2.conditional.ev <- df.prior.prevalence.2 %>%
  filter(response > 0) %>%
  group_by(property) %>%
  tidyboot_mean(column = response)


df.prior.prevalence.2.isZero.conditionalEv <- left_join(
  df.prior.2.conditional.ev %>%
    select(-n, -empirical_stat) %>%
    rename(pwp_mean = mean, pwp_low = ci_lower, pwp_high = ci_upper),
  df.prior.prevalence.2.isZero %>%
    select(-n, -empirical_stat) %>%
    rename(isZero = mean, zero_low = ci_lower, zero_high = ci_upper)
)

ggplot(df.prior.prevalence.2.isZero.conditionalEv, 
       aes( x = 1-isZero, xmin = 1-zero_low, xmax = 1-zero_high,
            y = pwp_mean, ymin = pwp_low, ymax = pwp_high))+
  geom_errorbar(alpha = 0.3) + geom_errorbarh(alpha = 0.3) + 
  geom_point(shape = 21, size = 2.6, color = 'black', fill = 'black')+
  scale_x_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1))+
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1))+
  ylab("Prevalence when present")+
  xlab("P(feature is present)")
```


```{r fig.width=6}
target.properties <- c("eat insects", 
                       "feed on the carcasses of dead animals",
                       "are afraid of loud noises",
                       "get in fights with other animals",
                       "live in urban areas",
                       "live in zoos",
                       #"drink alcohol left behind by tourists",
                       "chase their tails",
                       "have seizures")
var_width <- 20

save(df.prior.prevalence.2.isZero.conditionalEv,
     df.prior.prevalence.2,
     file = "../../paper/cached_results/genInt_priors.RData"
     )

df.prior.prevalence.2 %>%
  filter(property %in% target.properties) %>%
  mutate(property = factor(property, levels = target.properties,
                           labels = stringr::str_wrap(target.properties, 
                                                      width = var_width))) %>%
  ggplot(., aes( x = response ))+
  geom_histogram( 
    bins = 20,
    aes(y=(..count..)/tapply(..count..,..PANEL..,sum)[..PANEL..]),
    color = 'black', fill= 'white')+
  facet_wrap(~property, scales = 'free', nrow = 2) +
  scale_x_continuous(limits = c(-0.1, 1.1), breaks = c(0, 0.5, 1))+
  ylab("Proportion of responses")+
  xlab("Prevalence")

```

Copy interpretation df over from `generic-interpretation-1.Rmd`

```{r}
df.prior.2.ev.wInt <- left_join(
  df.prior.2.ev,
  #df.prior.2.conditional.ev,
  df.int.3.filtered.bs %>%
    rename(int_mean = mean, int_upper = ci_upper, int_lower = ci_lower) %>%
    select(property, int_mean, int_upper, int_lower)
) %>%
  mutate(sq_err = (mean - int_mean)^2)

ggplot(df.prior.2.ev.wInt, aes (x = mean, xmin = ci_lower, xmax = ci_upper,
                     y = int_mean, ymin = int_lower, ymax = int_upper))+
  geom_point()+
  geom_errorbar(alpha = 0.2)+
  geom_errorbarh(alpha = 0.2)+
  scale_x_continuous(limits = c(0, 1.1), breaks = c(0, 0.5, 1))+
  scale_y_continuous(limits = c(0, 1.1), breaks = c(0, 0.5, 1))+
  coord_fixed()
```


